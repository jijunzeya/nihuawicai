{"version":3,"sources":["../../src/handler/Roomhandler.js"],"names":["RoomHandler","id","nickName","nsp","socket","handleGameData","handleGameEvent","roomId","_namespace","_socket","initSocket","console","log","removeAllListeners","handshake","query","token","name","on","receiveMessage","bind","onUserChatMessage","GET_ROOMS","onGetRooms","onGetPointData","onGameEvent","data","fn","_rooms","message","point","JSON","stringify","event","action","to","emit","nick","socketId","broadcast","room"],"mappings":";;;;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;;;;;IACqBA,W;;AAcnB;;;AAVA;;AAeA,uBAAYC,EAAZ,EAAgBC,QAAhB,EAA0BC,GAA1B,EAA+BC,MAA/B,EAAuCC,cAAvC,EAAuDC,eAAvD,EAAwE;AAAA;;AACtE,SAAKC,MAAL,GAAcN,EAAd;AACA,SAAKC,QAAL,GAAgBA,QAAhB;AACA,SAAKM,UAAL,GAAkBL,GAAlB;AACA;AACA,SAAKM,OAAL,GAAeL,MAAf;AACA;AACA;AACA,SAAKE,eAAL,GAAuBA,eAAvB;AACA,SAAKD,cAAL,GAAsBA,cAAtB;;AAEA,SAAKK,UAAL,CAAgB,KAAKD,OAArB;AAED;;AAxBD;;AAEA;;;;wCAwBqB;AACnBE,cAAQC,GAAR,6BAAsC,KAAKH,OAAL,CAAaR,EAAnD;AACA,WAAKQ,OAAL,CAAaI,kBAAb,CAAgC,CAAC,SAAD,EAAY,UAAZ,EAAwB,WAAxB,EAAqC,WAArC,CAAhC;AACD;;;gCAEYZ,E,EAAIG,M,EAAQ;AACvB,WAAKG,MAAL,GAAcN,EAAd;AACA,WAAKQ,OAAL,GAAeL,MAAf;AACA,WAAKM,UAAL,CAAgBN,MAAhB;AACD;;;+BAEWA,M,EAAQ;AAClBO,cAAQC,GAAR,CAAY,uBAAuBR,OAAOU,SAAP,CAAiBC,KAAjB,CAAuBC,KAA9C,GAAsD,GAAtD,GAA4DZ,OAAOU,SAAP,CAAiBC,KAAjB,CAAuBE,IAA/F;AACA;AACA,WAAKR,OAAL,CAAaS,EAAb,CAAgB,SAAhB,EAA2B,KAAKC,cAAL,CAAoBC,IAApB,CAAyB,IAAzB,CAA3B;AACA;AACAhB,aAAOc,EAAP,CAAU,UAAV,EAAsB,KAAKG,iBAAL,CAAuBD,IAAvB,CAA4B,IAA5B,CAAtB;;AAEA;AACA;AACAhB,aAAOc,EAAP,CAAU,oBAAUI,SAApB,EAA+B,KAAKC,UAAL,CAAgBH,IAAhB,CAAqB,IAArB,CAA/B;;AAEAhB,aAAOc,EAAP,CAAU,WAAV,EAAuB,KAAKM,cAAL,CAAoBJ,IAApB,CAAyB,IAAzB,CAAvB;AACAhB,aAAOc,EAAP,CAAU,WAAV,EAAuB,KAAKO,WAAL,CAAiBL,IAAjB,CAAsB,IAAtB,CAAvB;AACD;;;+BAEWM,I,EAAMC,E,EAAI;AACpBA,YAAMA,GAAG,KAAKC,MAAR,CAAN;AACD;;;mCAEeC,O,EAAS;AACvBlB,cAAQC,GAAR,CAAY,0BAA0BiB,OAAtC;AACA;AACD;;AAED;;;;mCACgBC,K,EAAO;AACrB;AACA;AACA;AACA;AACA;AACA;AACA;AACAnB,cAAQC,GAAR,CAAY,wBAAwB,KAAKH,OAAL,CAAaR,EAArC,GAA0C,GAA1C,GAAgD8B,KAAKC,SAAL,CAAeF,KAAf,CAA5D;AACA,WAAKzB,cAAL,CAAoByB,KAApB;AAED;;;gCAEYG,K,EAAO;AAClB,UAAIA,SAASA,MAAMC,MAAnB,EAA2B;AACzB;AACA,aAAK5B,eAAL,IAAwB,KAAKA,eAAL,CAAqBwB,KAArB,CAAxB;AACD;AACF;;;sCAEkBD,O,EAAS;AAC1BlB,cAAQC,GAAR,CAAY,uBAAuBiB,OAAnC;AACA,WAAKrB,UAAL,CAAgB2B,EAAhB,CAAmB,KAAK5B,MAAxB,EAAgC6B,IAAhC,CAAqC,oBAArC,EAA2D;AACzDC,cAAM,KAAKnC,QAD8C;AAEzD2B,iBAASA;AAFgD,OAA3D;;AAMA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACD;;;gCAEYS,Q,EAAUL,K,EAAOJ,O,EAAS;AACrC;AACApB,cAAQ8B,SAAR,CAAkBJ,EAAlB,CAAqBG,QAArB,EAA+BF,IAA/B,CAAoCH,KAApC,EAA2CJ,OAA3C;AACD;;;sCAEkBW,I,EAAMP,K,EAAOJ,O,EAAS;AACvC;AACA,WAAKrB,UAAL,CAAgB2B,EAAhB,CAAmBK,IAAnB,EAAyBJ,IAAzB,CAA8BH,KAA9B,EAAqCJ,OAArC;AACD;;;iCAEa;AACZlB,cAAQC,GAAR,CAAY,UAAU,KAAKV,QAAf,GAA0B,cAAtC;AACA;AACD;;;;;;kBA3HkBF,W","file":"Roomhandler.js","sourcesContent":["import User from '../beans/User';\nimport Room from '../beans/Room';\nimport Constants from '../common/Constants';\nimport Game from '../game/Game';\nexport default class RoomHandler {\n\n  _socket;\n\n  // _user;\n\n  _namespace;\n\n  // createRoomCallback;\n\n  // joinedRoomCallback;\n\n  handleGameEvent;\n\n  // _rooms;\n  roomId;\n\n  nickName;\n\n  constructor(id, nickName, nsp, socket, handleGameData, handleGameEvent) {\n    this.roomId = id;\n    this.nickName = nickName;\n    this._namespace = nsp;\n    // this._rooms = rooms;\n    this._socket = socket;\n    // this.createRoomCallback = cCallback;\n    // this.joinedRoomCallback = jCallback;\n    this.handleGameEvent = handleGameEvent;\n    this.handleGameData = handleGameData;\n\n    this.initSocket(this._socket);\n\n  }\n\n  removeAllListener () {\n    console.log(`@@##removeAllListeners ${this._socket.id}`);\n    this._socket.removeAllListeners(['message', 'userChat', 'pointData', 'gameEvent']);\n  }\n\n  resetSocket (id, socket) {\n    this.roomId = id;\n    this._socket = socket;\n    this.initSocket(socket);\n  }\n\n  initSocket (socket) {\n    console.log('@@##initSocket @@:' + socket.handshake.query.token + ' ' + socket.handshake.query.name)\n    // this._user = new User(socket.id, socket.handshake.query.name);\n    this._socket.on('message', this.receiveMessage.bind(this));\n    // socket.on('disconnect', this.onDisConnect.bind(this));\n    socket.on('userChat', this.onUserChatMessage.bind(this));\n\n    // socket.on('createRoom', this.onCreateRoom.bind(this));\n    // socket.on('joinRoom', this.onJoinRoom.bind(this));\n    socket.on(Constants.GET_ROOMS, this.onGetRooms.bind(this));\n\n    socket.on('pointData', this.onGetPointData.bind(this));\n    socket.on('gameEvent', this.onGameEvent.bind(this));\n  }\n\n  onGetRooms (data, fn) {\n    fn && fn(this._rooms);\n  }\n\n  receiveMessage (message) {\n    console.log('chat receive message:' + message);\n    // 然后呢 =\n  }\n\n  // 接收游戏数据\n  onGetPointData (point) {\n    // if (!this.game) {\n    //   this.game = new Game((event) => {\n    //     // this._namespace.to(this._user.roomId).emit('gamePointData', p);\n    //     this.sendMessageToRoom(this.roomId, event.name, event.data);\n    //   });\n    // }\n    // this.game.handleData(point);\n    console.log('@@##onGetPointData:' + this._socket.id + ' ' + JSON.stringify(point));\n    this.handleGameData(point);\n\n  }\n\n  onGameEvent (event) {\n    if (event && event.action) {\n      // this.game && this.game.handleGameEvent(event);\n      this.handleGameEvent && this.handleGameEvent(point);\n    }\n  }\n\n  onUserChatMessage (message) {\n    console.log('onUserChatMessage:' + message);\n    this._namespace.to(this.roomId).emit('serverSendUserChat', {\n      nick: this.nickName,\n      message: message\n    });\n\n\n    // let curRoom = this._rooms[this._user.roomId];\n    // if (curRoom) {\n    //     let users = curRoom.users;\n    //     for (let user of users) {\n    //         this._namespace.to(user.id).emit('serverSendUserChat', {\n    //             nick: user.nickName,\n    //             message: message + 'from' + user.nickName\n    //         });\n    //     }\n    // }\n  }\n\n  sendMessage (socketId, event, message) {\n    //发消息到房间还是给人\n    _socket.broadcast.to(socketId).emit(event, message);\n  }\n\n  sendMessageToRoom (room, event, message) {\n    //发消息到房间还是给人呢\n    this._namespace.to(room).emit(event, message);\n  }\n\n  disConnect () {\n    console.log('User ' + this.nickName + ' disconneted');\n    // this._socket.disConnect();\n  }\n\n}"]}